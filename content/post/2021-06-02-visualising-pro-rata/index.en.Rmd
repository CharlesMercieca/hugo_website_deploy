---
title: "Visualising that Pro-Rata Allocation (...I think)"
author: ''
date: '2021-06-02'
slug: visualising-pro-rata
categories: []
tags: []
type: ''
subtitle: ''
image: ''
---

A considerable amount of discussion has been generated by [the Auditor General's flagging of ARMS' pro-rata billing](https://timesofmalta.com/articles/view/auditor-general-flags-65m-extra-charges-on-utility-bills-for-consumers.874582). I find some billing concepts quite hard to understand abstractly, so here's my attempt at trying to visualize the issue.

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(purrr)
library(scales)
library(plotly)
```

## Creating a function to generate our bills

The rates of utilities in Malta are regulated by an official body, and [the current rates](https://www.rews.org.mt/#/en/fa/31) have been in use since 2014. The setup is quite similar to how a marginal tax rate is worked out, exhausting your share of credits in a brackets before moving to the next one.

To keep things simple, I chose to only model a residential tariff for 1 person, without the added complexities of things like eco-reduction and the meter rental fee.

My first attempt was this ugly gargantuan function:

```{r message=FALSE, warning=FALSE}
calculate_bill_residential <- function(service_charge = 0, 
                                       kwh, 
                                       p = 1) {
  
  # takes kWh used and calculates usage in euros as per residential bands
  # also accepts optional service charge (rental) fee
  # over p, or billing period, where 1 = annually, 3 = quarterly, 6 = twice-monthly
  
  bill <- 0
  
  #Band 1
  if (kwh > 0 & kwh <= (2000 / p)) {
    bill <- kwh * 0.1047
  #Band 2
  } else if (kwh > 2000 / p & kwh <= 6000  / p) {
    bill <- 209.4 / p + (kwh - 2000 / p) * 0.1298
  #Band 3  
  } else if (kwh > 6000 / p & kwh <= 10000 / p) {
    bill <- 728.4702 / p + (kwh - 6000 / p) * 0.1607
  #Band 4  
  } else if (kwh > 10001 / p & kwh <= 20000 / p) {
    bill <- 1371.11 / p + (kwh - 10001 / p) * 0.3420
  #Band 5  
  } else if (kwh > 20000 / p) {
    bill <- 4790.768 / p + (kwh - 20000 / p) * 0.6076
  }
  return(bill + (service_charge / p))
}

```

[although subsequent trawling on stack overflow](https://stackoverflow.com/a/33771942) pointed me to this exceptionally elegant way of doing the same thing using R's base `pmin` and `diff` functions:

```{r message=FALSE, warning=FALSE}
residential_bill_stackoverflow <- 
  function(service_charge = 0,
           kwh,
           p = 1,
           bands = c(2001/p, 6001/p, 10001/p, 20000/p, Inf),
           rates = c(0.1047, 0.1298, 0.1607, 0.3420, 0.6076)) {        
    sum((diff(c(0, pmin(kwh, bands))) * rates) + (service_charge / p))
  }

```

In any case, I tested it out against [ARMS's bill calculator](https://arms.com.mt/en/services/bills/bill-calculator) for a few example cases, and the difference in usage was typically around the 1 euro mark, especially for the sub 8,000 unit consumption I mostly played with. That being said, if it looks like I messed up in the above, it's probably because I have.

But the rest now is relatively easy. We can create a dataframe of possible consumption and billing period combinations using `expand.grid:`

```{r message=FALSE, warning=FALSE}
energy_use_df <- expand.grid(
  service_charge = 0,
  kwh = seq(0, 10000, by = 100),
  p = c(1, 3, 6)
)
```

That generates something like this:

```{r message=FALSE, warning=FALSE}
energy_use_df %>% 
  head()
```

And all that's left to do is apply our function in a rowwise manner using *kwh* and *p* as parameters. Purrr's `map`makes this easy:

```{r}
energy_use_df <- energy_use_df %>% 
  mutate(kont = pmap(energy_use_df, calculate_bill_residential)) %>% 
  inner_join(tibble(p = c(1, 3, 6),
                    Schedule = c("Yearly", 
                                 "Quarterly", 
                                 "Every 2 Months"))) %>%
  mutate(kont = round(as.numeric(kont), 2))
```

And we can then pipe the result to ggplot/plotly:

```{r message=FALSE, warning=FALSE}
graph <- ggplot(energy_use_df, aes(x = kwh, y = kont, col = Schedule))+
  geom_point()+
  geom_line()+
  theme_bw()+
  scale_y_continuous(labels = dollar_format(suffix = "€", prefix = ""))+
  labs(title = "How much of a difference do billing intervals make?",
       subtitle = "The same usage billed using three different schedules")+
  ylab("Euros")+
  xlab("kWh") 
ggplotly(graph)
```

The difference at low usage (say sub 2,000kWh) is a couple of tens of euros for most people, but it does increase significantly at higher usage rates (although no one is using 10,000 units as a single person, so this graphic breaks down at that extreme end.

And here's a more zoomed in view on the bit that actually interests most households, unless you're trying to create an artificial lightning bolt or something.

```{r}
zoomed <- ggplot(filter(energy_use_df, kwh <=2000), 
                aes(x = kwh, y = kont, col = Schedule))+
  geom_point()+
  geom_line()+
  theme_bw()+
  scale_y_continuous(labels = dollar_format(suffix = "€", prefix = ""))+
  labs(title = "How much of a difference do billing intervals make?",
       subtitle = "The same usage billed using three different schedules")+
  ylab("Euros")+
  xlab("kWh") 
ggplotly(zoomed)
```

Now of course all of this is completely separate from whether ARMS should be billing you on a pro-rata basis or not. For what it's worth, [this MRA document on page 5](https://downloads.rews.org.mt/files/21f24532-8db4-4d0b-994c-e3eda25dd112_684e0093-c79f-472d-9497-0f4ef5ff9561.pdf) seems to give it's approval for such a mechanism.

Ultimately, it's also in your interest as a citizen to have a utility service capable of turning a profit, since this is how they invest back into their network with greener and more reliable technology.
